@{
    Layout = null;
}
<!DOCTYPE html>
<html>
<head>
    <style>

    </style>
    <link href="~/Content/icono.min.css" rel="stylesheet" />
    <link href="~/Content/css/index.css" rel="stylesheet" />
    @*<link href="~/content/icono.min.css" rel="stylesheet" />*@
    <meta name="viewport" content="width=device-width" />
    <title>Daker</title>
</head>
<body>
    <div style="text-align: right">
        <div class="usr-state">
            <span>你好,</span><span id="curUser">你还没有登录</span>
        </div>
    </div>

    <div class="fl-left">
        <div class="on-line">
            <div class="title">
                当前在线用户共8人.
            </div>
            <div>
                <ul>

                    <li class="one-li"><img src="~/images/1.jpg" /><span class="nick">Jack</span> </li>
                    <li class="one-li"><img src="~/images/1.jpg" /><span class="nick">Lisa</span> </li>
                    <li class="one-li"><img src="~/images/1.jpg" /><span class="nick">Lusan</span> </li>
                    <li class="one-li"><img src="~/images/1.jpg" /><span class="nick">Nifa</span> </li>
                    <li class="one-li"><img src="~/images/1.jpg" /><span class="nick">Jack</span> </li>

                </ul>
            </div>

        </div>
        <div class="what-new">
            <div class="title">动态</div>
            <div class="list">
                <ul>
                    <li class="off-state">
                        windfierce离开了房间.
                    </li>
                    <li class="on-state">
                        windfierce进入了房间.
                    </li>
                    <li class="off-state">
                        windfierce离开了房间.
                    </li>
                    <li class="on-state">
                        windfierce进入了房间.
                    </li>
                    <li class="off-state">
                        windfierce离开了房间.
                    </li>
                    <li class="on-state">
                        windfierce进入了房间.
                    </li>
                    <li class="off-state">
                        windfierce离开了房间.
                    </li>
                    <li class="on-state">
                        windfierce进入了房间.
                    </li>
                    <li class="off-state">
                        windfierce离开了房间.
                    </li>
                    <li class="on-state">
                        windfierce进入了房间.
                    </li>
                    <li class="off-state">
                        windfierce离开了房间.
                    </li>
                    <li class="on-state">
                        windfierce进入了房间.
                    </li>
                    <li class="off-state">
                        windfierce离开了房间.
                    </li>
                    <li class="on-state">
                        windfierce进入了房间.
                    </li>
                    <li class="off-state">
                        windfierce离开了房间.
                    </li>
                    <li class="on-state">
                        windfierce进入了房间.
                    </li>
                </ul>
            </div>
        </div>
    </div>
    <!--聊天框-->
    <div id="container" class="enviroment-big">
        <div class="msg-list">
        </div>
        <div class="typearea">
            <div style="border:none;"><input type="text" class="msg" placeholder="输入..." /><a class="sendbtn"><span class=" icon"><span class="text">发送</span></span>  </a> </div><div></div>
        </div>
    </div>
    <!--聊天框 end-->
    <!--登录-->
    <div class="login">
        <div>
            <div class="tang-title">
                登录到DAKER
            </div>
            <form id="fm">

                <div>
                    <div class="input-con">
                        <span class="icono-user"></span><input type="text" name="Name" id="Name" placeholder="用户名" />
                    </div>
                </div>
                <div>
                    <div class="input-con">
                        <span class="icono-flickr"></span><input type="password" name="Password" id="Password" placeholder="密码" />
                    </div>

                </div>
                <div class="login-btn-con">
                    <a id="login" href="#" class="login-btn">登录</a>
                </div>
                <div class="reg-con">
                    <a id="reg" href="@Url.Action("Regester","Member")">立即注册</a>
                </div>
            </form>

        </div>
    </div>
</body>
</html>
<script src="~/Scripts/jquery-2.1.4.min.js"></script>
<script>


    var dChat = {
        config: {
            apiHost: 'http://localhost:53432',
            maxMsgLength: 100,
            maxExistDom: 10,
            requestTimeout: 5,
            timeout: 3
        },
        Index: '',
        user: {}
        ,
        initial: function (dom, user, msgs) {
            dChat.user = user;
            this.setLoginState(user.NickName);
            this.polling();

        }
        ,
        setLoginState: function (usrName) {
            $("#curUser").text(usrName);
        }
        ,
        polling: function () {
            $.ajax(
                {
                    url: dChat.config.apiHost + "/Message/get?id=" + dChat.Index,
                    type: 'get',
                    datatype: 'jsonp',
                    jsonp: 'callback',
                    timeout: dChat.config.timeout,
                    success: function (data) {
                        if (data.length > 0) {
                            dChat.Index = $(data).last().Id;
                            if (data instanceof Array) {
                                $(data).each(function () {
                                    if (dChat.filtered($(this))) {
                                        dChat.popLeft($(this));
                                    }
                                });

                            } else {
                                if (dChat.filtered($(data))) {
                                    dChat.popLeft($(data));
                                }
                            }
                        }
                        dChat.polling();

                    },
                    error: function () {
                        setTimeout(dChat.polling, 3000);//出现错误，则3秒后重试
                    }

                }
            );
        },
        send: function () {
            var msg = $(".typearea .msg").val();
            $(".typearea .msg").val("");
            var msgObject = { MsgContent: msg, Sender: this.user }
            $.ajax({
                url: this.config.apiHost + '/Message/push?value=' + msg,
                data: JSON.stringify({ MsgContent: msg, UserId: this.user.UserId, Sender: this.user }),
                type: "post",
                contenttype: "application/json",
                datatype: 'jsonp',
                jsonp: 'callback'
            });
            dChat.popRight(msgObject);


        }
        ,
        filtered: function (msg) {
            if (msg && msg.Sender.Id != this.user.Id) {
                return true;
            }
            return false;

        }
        ,
        popRight: function (data) {
            var msg = decodeURI(data.MsgContent);
            var sender = data.Sender;
            var msbody = $("<div>").addClass("right").append($("<div>").addClass("mscontent").text(msg)).append($("<div>").addClass("head").append($("<img>").attr("src", sender.HeadImgPath)));
            $(".msg-list").append(msbody);
            if ($(".msg-list>.left,.msg-list>.right").length > dChat.config.maxExistDom) {
                var rmIndex = $(".msg-list>.left,.msg-list>.right").length - dChat.config.maxExistDom;
                var extraDoms = $(".msg-list>div:lt(" + rmIndex + ")");
                extraDoms.remove();
            }
            var height = $(".msg-list").get(0).scrollHeight;
            //HandleScroll();
            $(".msg-list").animate({ scrollTop: height }, 800);
        }
        ,
        popLeft: function (data) {
            var msg = decodeURI(data.MsgContent);
            var sender = data.Sender;
            var msbody = $("<div>").addClass("left").append($("<div>").addClass("head").append($("<img>").attr("src", sender.HeadImgPath)).append($("<div>").addClass("nickname").text(sender.NickName))).append($("<div>").addClass("mscontent").text(msg));
            $(".msg-list").append(msbody);
            if ($(".msg-list>.left,.msg-list>.right").length > dChat.config.maxExistDom) {
                var rmIndex = $(".msg-list>.left,.msg-list>.right").length - dChat.config.maxExistDom;
                var extraDoms = $(".msg-list>div:lt(" + rmIndex + ")");
                extraDoms.remove();
            }
            var height = $(".msg-list").get(0).scrollHeight;
            $(".msg-list").animate({ scrollTop: height }, 800);
        }
    };
    //点击发送
    $(".sendbtn").click(function () {
        dChat.send();
    });
    //ctrl+enter发送
    $(document).keydown(function (event) {
        if (event.ctrlKey && event.keyCode == 13) {
            dChat.send();
        }
    });
    $("#login").click(function () {
        var name = $("#Name").val();
        var pwd = $("#Password").val();
        if (!name || !pwd) {
            alert("请输入用户名密码.");
            return;
        }
        $(this).addClass("loading");
        $(this).text("");
        $(this).attr("disabled", "true");
        $.ajax({
            url: "../Member/Login",
            type: 'post',
            data: $("#fm").serialize(),
            datatype: 'json',
            success: function (jsondata) {
                if (jsondata.status) {
                    $(".login").slideUp();
                    dChat.initial($(".msg-list"), jsondata.Data);
                } else {
                    {
                        alert("用户名或密码错误.");

                    }
                }
            }, error: function () {
                alert("服务器错误.");
            },
            complete: function () {
                $("#login").removeClass("loading");
                $("#login").text("登录");
                $("#login").removeAttr("disabled");
            }
        });
    });
</script>
<script>
</script>